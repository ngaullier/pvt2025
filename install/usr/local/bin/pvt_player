#! /usr/bin/env bash

exit_fail ()
{
    zenity --error --title="${BASH_SOURCE[0]##*/}" --text="$*"
    exit 1
}

#{{{ setup_player
setup_player ()
{
    local mpv_config_dir="/usr/local/etc/pvt_player"
    local screen_id=0

    mpv_cmd=(mpv        \
        "--loop"        \
        "--no-audio"    \
        "--fs-screen=${screen_id}"       \
        "--config-dir=${mpv_config_dir}" \
        "$1"
    )
    ff_lavfi=()

    if (( $# == 1 )); then
        mpv_cmd+=(
            "--script=${mpv_config_dir}/trim.lua"
        )
    else
        mpv_cmd+=(
            "--external-file=$2"
            "-input-commands"   "load-input-conf ${mpv_config_dir}/input_$#.conf,keypress KP5"
        )
        local name2="${2##*/}"
        local id2="${name2%.*}"
        local vf_drawtext_top="drawtext=fontcolor=white:borderw=2:fontsize=30:x=(w-text_w)/2:y=20:text"

        if (( $# == 2 )); then
            local name1="${1##*/}"
            local id1="${name1%.*}"
            ff_lavfi+=(
                "[vid1]${vf_drawtext_top}=${id1} %{pict_type}[v1]"  \
                "[vid2]${vf_drawtext_top}=${id2} %{pict_type}[v2]"  \
                "[v1][v2]vstack=2[vo]"
            )
        else
            local name3="${3##*/}"
            local id3="${name3%.*}"
            mpv_cmd+=(
                "--external-file=$3"
            )
            ff_lavfi+=(
                "[vid2]${vf_drawtext_top}=${id2} %{pict_type}[v2]"  \
                "[vid3]${vf_drawtext_top}=${id3} %{pict_type}[v3]"  \
                "[v2][v3][vid1]vstack=3[vo]"
            )
        fi
    fi
}
#}}}

#{{{ fire_player
fire_player ()
{
    local IFS=","
    echo "${mpv_cmd[@]}" "\"--lavfi-complex=${ff_lavfi[*]}\""
    "${mpv_cmd[@]}" "--lavfi-complex=${ff_lavfi[*]}"
}
#}}}

(( $# >= 1 & $# <= 3 )) || exit_fail "Erreur: attend 1 Ã  3 fichiers..."
setup_player "$@"
fire_player
